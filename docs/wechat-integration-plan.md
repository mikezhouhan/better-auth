# better-auth 集成微信提供者计划

## 问题描述

微信社交提供者不返回用户的电子邮件地址，而 `better-auth` 的许多核心功能和数据模型依赖于电子邮件作为用户唯一标识符。这导致在集成微信提供者时遇到挑战。

## 目标

在不大幅修改 `better-auth` 核心代码的前提下，实现微信提供者与 `better-auth` 的集成，并处理无电子邮件用户的身份识别和相关功能依赖问题。

## 方案评估与选择

经过分析和与用户的讨论，我们选择在现有微信提供者代码中注入虚拟电子邮件，并结合配置/钩子处理基于电子邮件的功能。

## 详细计划

1.  **修改现有微信提供者 (`packages/better-auth/src/social-providers/wechat.ts`)：**
    *   在 `getUserInfo` 方法中，获取到微信用户原始信息后。
    *   检查原始信息中是否包含电子邮件字段。
    *   如果不存在电子邮件，生成一个唯一的虚拟电子邮件地址。建议格式：`wechat_user_[unionid/openid]@yourdomain.com`。
    *   将生成的虚拟电子邮件添加到返回的 `user` 对象中，例如 `email: generatedVirtualEmail, emailVerified: false`。
    *   保留使用 `profile.unionid` (优先) 或 `profile.openid` 作为 `user.id` 的逻辑。

2.  **处理基于电子邮件的功能：**
    *   由于在提供者层面注入了虚拟电子邮件，`better-auth` 的核心流程可能会尝试使用这些虚拟电子邮件进行邮件验证、密码重置等。
    *   需要通过配置或钩子的方式，在需要电子邮件的功能处进行特殊处理。例如，在配置 `better-auth` 时，为邮件验证和密码重置提供自定义的处理函数，这些函数可以检查用户是否为微信用户（例如通过检查 `Account` 表中的 `providerId`），并根据需要引导用户使用其他验证方式（如手机号）。

3.  **更新文档：** 详细说明修改后的微信提供者逻辑，以及如何配置 `better-auth` 来处理微信用户的基于电子邮件的功能。

## 方案流程图

```mermaid
graph TD
    A[用户点击微信登录] --> B(better-auth 授权流程)
    B --> C{微信回调}
    C --> D(获取微信用户信息)
    D --> E(修改微信提供者 getUserInfo)
    E --> F{用户是否有电子邮件?}
    F -- 否 --> G(生成虚拟电子邮件)
    F -- 否 --> H(注入虚拟电子邮件到用户信息)
    F -- 是 --> I(使用原始用户信息)
    G --> H
    H --> J(返回处理后的用户信息)
    I --> J
    J --> K(better-auth 回调处理)
    K --> L(使用 unionid/openid 作为主标识)
    K --> M(存储用户信息到数据库)
    M --> N(创建会话)
    N --> O(设置 Session Cookie)
    O --> P(重定向到回调 URL)
    P --> Q{需要基于电子邮件的功能?}
    Q -- 是 --> R(通过配置/钩子处理，集成其他验证方式)
    Q -- 否 --> S(正常使用)